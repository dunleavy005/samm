## Test model fits against one another

import os
import pickle
import csv

from os.path import join
from nestly.scons import SConsWrap
from nestly import Nest
from SCons.Script import Environment, Command, AddOption
from matsen_grp_data import SCRATCH_DIR
from hier_motif_feature_generator import HierarchicalMotifFeatureGenerator
from itertools import izip

Import('env')
localenv = env.Clone()

# Set up state
base = {'nreps': localenv['NREPS'],
        'output_name': localenv['OUTPUT_NAME']}

nest = SConsWrap(Nest(base_dict=base), '_'+localenv['OUTPUT_NAME'], alias_environment=localenv)

MOTIF_LEN = 5
MUTATING_POSITION = 2
# !!
PENALTY_PARAMS = ','.join([.001, .0001])

# Nest for replicates
nest.add(
    'replicate',
    range(localenv['NREPS']),
    label_func='{:02d}'.format)

# Set the seed to be the replicate number.
nest.add(
    'seed',
    lambda c: [c['replicate']],
    create_dir=False)

# Targets for simulating fake data
@nest.add_target_with_env(localenv)
def generate(env, outdir, c):
    cmd = ['python simulate_from_sampled_gls.py simulate',
           '--seed',
           c['seed'],
           '--use-s5f',
           '--output-true-theta ${TARGETS[0]}',
           '--output-genes ${TARGETS[1]}',
           '--output-seqs ${TARGETS[2]}',
           '--output-per-branch-genes ${TARGETS[3]}',
           '--output-per-branch-seqs ${TARGETS[4]}']

    return env.Command(
        [join(outdir, 'true_theta.pkl'), join(outdir, 'genes.csv'), join(outdir, 'seqs.csv'),
         join(outdir, 'genes_with_ancestors.csv'), join(outdir, 'seqs_with_ancestors.csv')],
        [],
        ' '.join(map(str, cmd)))

nest.add(
    'motif_length',
    [
        5,
    ],
    label_func='{:02d}mers'.format)

@nest.add_target_with_env(localenv)
def process(env, outdir, c):
    cmd = ['python preprocess_data.py',
           '--input-genes ${SOURCES[1]}',
           '--input-seqs ${SOURCES[2]}',
           '--motif-len',
           MOTIF_LEN,
           '--impute-ancestors',
           '--scratch-directory',
           SCRATCH_DIR,
           '--output-genes ${TARGETS[0]}',
           '--output-seqs ${TARGETS[1]}']

    return env.Command(
        [join(outdir, 'genes_with_imputed_ancestors.csv'), join(outdir, 'seqs_with_imputed_ancestors.csv')],
        c['generate'],
        ' '.join(map(str, cmd)))

def write_truth(target, source, env):
    c = env['control']
    with open(str(source[0]), 'r') as f:
        theta, _ = pickle.load(f)

    feat_generator = HierarchicalMotifFeatureGenerator(motif_lens=[MOTIF_LEN])
    motif_list = feat_generator.motif_list
    mutabilities = theta

    with open(str(target[0]), 'wb') as f:
        writer = csv.writer(f)
        writer.writerow(
            'rep sim model'.split() +
            [motif.upper() for motif in motif_list]
        )
        writer.writerow([
            c['replicate'],
            'truth'] +
            mutabilities.ravel().tolist()
        )

@nest.add_target_with_env(localenv)
def convert_truth(env, outdir, c):
    return env.Command(
        join(outdir, 'true_theta.csv'),
        c['generate'],
        write_truth,
        control=c)

nest.add_aggregate('compare_models', list)

data_dict = [
    {'data_type': 'true_ancestors',
     'sampling_option': 1},
    {'data_type': 'imputed_ancestors',
     'sampling_option': 1},
    {'data_type': 'all_data',
     'sampling_option': 1},
    {'data_type': 'sample_random',
     'sampling_option': 2},
]

nest.add(
    'data_type',
    data_dict,
    label_func=lambda c: c['data_type'])

# fit survival
@nest.add_target_with_env(localenv)
def fit_survival(env, outdir, c):
    cmd = []
    motif_len = MOTIF_LEN
    left_flanks = MUTATING_POSITION
    penalty_params = PENALTY_PARAMS

    cmd = ['python fit_context_model.py',
           '--seed',
           c['seed'],
           '--motif-lens',
           motif_len,
           '--positions-mutating',
           left_flanks,
           '--penalty-params',
           penalty_params,
           '--num-cpu-threads',
           4,
           '--num-jobs',
           20,
           '--burn-in',
           2,
           '--num-e-samples',
           4,
           '--em-max-iters',
           10,
           '--num-val-burnin',
           2,
           '--num-val-samples',
           4,
           '--sample-regime',
           SAMPLE_OR_IMPUTE, # sample one seq from clonal family
           '--scratch-directory',
           SCRATCH_DIR,
           '--tuning-sample-ratio',
           0.1,
           '--out-file ${TARGETS[0]}',
           '--log-file ${TARGETS[1]}',
           '--per-target-model']

    if c['data_type'] == 'true_ancestors':
        cmd += ['--input-genes ${SOURCES[0][3]} --input-seqs ${SOURCES[0][4]}']
    elif c['data_type'] == 'imputed_ancestors':
        cmd += ['--input-genes ${SOURCES[1][0]} --input-seqs ${SOURCES[1][2]}']
    else:
        cmd += ['--input-genes ${SOURCES[0][1]} --input-seqs ${SOURCES[0][2]}']

    return env.Command(
        [join(outdir, 'fitted.pkl'), join(outdir, 'log.txt'), join(outdir, 'fitted_train_seqs.csv'), join(outdir, 'fitted_train_genes.csv')],
        [c['generate'], c['process']],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def fit_shazam(env, outdir, c):

    cmd = ['python fit_shmulate_model.py',
           '--input-file',
           '${SOURCES[2]}',
           '--input-genes',
           '${SOURCES[3]}',
           '--model-pkl ${TARGETS[0]}',
           '--log-file ${TARGETS[1]}']

    return env.Command(
        [join(outdir, 'fitted_shazam.pkl'), join(outdir, 'log_shazam.txt')],
        c['fit_survival'],
        ' '.join(map(str, cmd)))

@nest.add_target_with_env(localenv)
def convert_fit(env, outdir, c):

    def write_files(target, source, env):
        c = env['control']
        with open(str(source[0]), 'r') as f:
            theta, _ = pickle.load(f)

        feat_generator = HierarchicalMotifFeatureGenerator(motif_lens=[c['motif_length']])
        motif_list = feat_generator.motif_list
        mutabilities = theta

        with open(str(target[0]), 'wb') as f:
            writer = csv.writer(f)
            writer.writerow(
                'rep sim data model'.split() +
                [motif.upper() for motif in motif_list]
            )
            writer.writerow([
                c['replicate'],
                c['data_type']['data_type'],
                c['model_options']] +
                mutabilities.ravel().tolist()
            )

    c['compare_models'].append(env.Command(
        join(outdir, 'fitted.csv'),
        c['fit_context_model'],
        write_files,
        control=c))

nest.pop('data_type')

# concatenate into one file with parameter values and what type of data we obtained.
@nest.add_target_with_env(localenv)
def summarize(env, outdir, c):
    def cat_files(target, source, env):
        with open(str(target[0]), 'w') as catted_files:
            with open(str(source[0])) as first_file:
                # keep header from first file
                for line in first_file:
                    catted_files.write(line)

            for fname in source[1:]:
                with open(str(fname)) as next_file:
                    next(next_file)
                    for line in next_file:
                        catted_files.write(line)
    return env.Command(
        join(outdir, 'results.csv'),
        c['compare_models'],
        cat_files)

