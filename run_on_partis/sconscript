## Test model fits against one another

import os

from os.path import join
from nestly.scons import SConsWrap
from nestly import Nest
from SCons.Script import Environment, Command, AddOption
from random import randint
from matsen_grp_data import *

Import('env')
localenv = env.Clone()

# Set up state
base = {'output_name': localenv['OUTPUT_NAME']}

nest = SConsWrap(Nest(base_dict=base), '_'+localenv['OUTPUT_NAME'], alias_environment=localenv)

# Nest for datasets
nest.add(
    'datasets',
    ['laura', 'kate'])

nest.add(
    'data_path',
    lambda c: [LAURA_DATA_PATH if c['datasets'] == 'laura' else KATE_DATA_PATH],
    create_dir=False)

# Chains and classes
nest.add(
    'chain',
    ['h', 'k', 'l'])

nest.add(
    'igclass',
    lambda c: 'G' if c['chain'] == 'h' else c['chain'].upper(),
    create_dir=False)

# Targets
nest.add(
    'model_options',
    [
        'survival',
        #'shazam'
    ])

motif_params_dict = [
    {'motif_length': '5', 'left_motif_flanks': '2'},
    {'motif_length': '3', 'left_motif_flanks': '0,1,2'},
    #{'motif_length': '3,5,7', 'left_motif_flanks': '1:2:3'},
]

# Nest for model fitting
@nest.add_target_with_env(localenv)
def fit_models(env, outdir, c):
    cmd = []
    motif_len = c['motif_params']['motif_length']
    left_flanks = c['motif_params']['left_motif_flanks']
    if c["model_options"].startswith("survival"):
        if motif_len == '5':
            penalty_params = ",".join(map(str, np.power(10, np.arange(-1.5, -2.0, step=-0.1)).tolist()))
        elif motif_len == '3,5,7':
            penalty_params = ",".join(map(str, np.power(10, np.arange(-1.0, -2.5, step=-0.25)).tolist()))
        elif motif_len == '3' and c['per_target']:
            penalty_params = ",".join(map(str, np.power(10, np.arange(-1.25, -1.35, step=-0.025)).tolist()))
        elif motif_len == '3' and not c['per_target']:
            penalty_params = ",".join(map(str, np.power(10, np.arange(-1.25, -2.5, step=-0.25)).tolist()))

        cmd = ['python fit_context_model.py',
               '--seed',
               c['seed'],
               '--motif-lens',
               motif_len,
               '--positions-mutating',
               left_flanks,
               '--penalty-params',
               penalty_params,
               '--num-cpu-threads',
               4,
               '--num-jobs',
               20,
               '--burn-in',
               2,
               '--num-e-samples',
               4,
               '--em-max-iters',
               10,
               '--num-val-burnin',
               2,
               '--num-val-samples',
               4,
               '--num-val-threads',
               4,
               '--scratch-directory',
               SCRATCH_DIR,
               '--tuning-sample-ratio',
               0.1,
               '--out-file ${TARGETS[0]}',
               '--log-file ${TARGETS[1]}']
        if c['validation_methods'] is not 'none':
            cmd += [
               '--validation-column',
               c['validation_methods']]
        if c['sample_or_impute'] == 'sample':
            cmd += ['--sample-regime', 2]
        if c["per_target"]:
            cmd += ['--per-target-model']
    elif c["model_options"] == "shazam" and motif_len == '5' and left_flanks == '2':
        cmd = ['python fit_shmulate_model.py',
               '--input-file ${SOURCES[0]}',
               '--input-genes ${SOURCES[1]}',
               '--model-pkl ${TARGETS[0]}',
               '--log-file ${TARGETS[1]}']
    return env.Command(
        [join(outdir, 'fitted.pkl'), join(outdir, 'log.txt')],
        [],
        ' '.join(map(str, cmd)))

